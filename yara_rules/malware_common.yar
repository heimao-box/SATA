/*
    通用恶意软件检测规则
    用于检测常见的恶意软件特征和行为
*/

rule Suspicious_API_Calls
{
    meta:
        description = "检测可疑的API调用组合"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "medium"
        category = "api_usage"

    strings:
        $api1 = "CreateRemoteThread" ascii wide
        $api2 = "VirtualAllocEx" ascii wide
        $api3 = "WriteProcessMemory" ascii wide
        $api4 = "OpenProcess" ascii wide
        $api5 = "GetProcAddress" ascii wide
        $api6 = "LoadLibrary" ascii wide

    condition:
        3 of ($api*)
}

rule Code_Injection_Pattern
{
    meta:
        description = "检测代码注入模式"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "high"
        category = "injection"

    strings:
        $inject1 = "CreateRemoteThread" ascii wide
        $inject2 = "VirtualAllocEx" ascii wide
        $inject3 = "WriteProcessMemory" ascii wide
        $inject4 = "SetThreadContext" ascii wide
        $inject5 = "ResumeThread" ascii wide

    condition:
        2 of ($inject*)
}

rule Registry_Persistence
{
    meta:
        description = "检测注册表持久化机制"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "medium"
        category = "persistence"

    strings:
        $reg1 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide
        $reg2 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnce" ascii wide
        $reg3 = "SYSTEM\\CurrentControlSet\\Services" ascii wide
        $reg4 = "RegCreateKey" ascii wide
        $reg5 = "RegSetValue" ascii wide

    condition:
        any of ($reg*)
}

rule Network_Communication
{
    meta:
        description = "检测网络通信功能"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "low"
        category = "network"

    strings:
        $net1 = "InternetOpen" ascii wide
        $net2 = "InternetConnect" ascii wide
        $net3 = "HttpSendRequest" ascii wide
        $net4 = "URLDownloadToFile" ascii wide
        $net5 = "WinHttpOpen" ascii wide
        $net6 = "socket" ascii wide
        $net7 = "connect" ascii wide
        $net8 = "send" ascii wide
        $net9 = "recv" ascii wide

    condition:
        2 of ($net*)
}

rule Anti_Debug_Techniques
{
    meta:
        description = "检测反调试技术"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "medium"
        category = "evasion"

    strings:
        $debug1 = "IsDebuggerPresent" ascii wide
        $debug2 = "CheckRemoteDebuggerPresent" ascii wide
        $debug3 = "OutputDebugString" ascii wide
        $debug4 = "GetTickCount" ascii wide
        $debug5 = "QueryPerformanceCounter" ascii wide
        $debug6 = "NtQueryInformationProcess" ascii wide

    condition:
        any of ($debug*)
}

rule Crypto_Functions
{
    meta:
        description = "检测加密相关功能"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "low"
        category = "cryptography"

    strings:
        $crypto1 = "CryptAcquireContext" ascii wide
        $crypto2 = "CryptCreateHash" ascii wide
        $crypto3 = "CryptEncrypt" ascii wide
        $crypto4 = "CryptDecrypt" ascii wide
        $crypto5 = "CryptGenKey" ascii wide
        $crypto6 = "CryptImportKey" ascii wide

    condition:
        2 of ($crypto*)
}

rule File_Operations
{
    meta:
        description = "检测可疑文件操作"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "low"
        category = "file_operation"

    strings:
        $file1 = "DeleteFile" ascii wide
        $file2 = "MoveFile" ascii wide
        $file3 = "CopyFile" ascii wide
        $file4 = "CreateFile" ascii wide
        $file5 = "WriteFile" ascii wide
        $file6 = "ReadFile" ascii wide
        $file7 = "SetFileAttributes" ascii wide

    condition:
        3 of ($file*)
}

rule Process_Manipulation
{
    meta:
        description = "检测进程操作"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "medium"
        category = "process"

    strings:
        $proc1 = "CreateProcess" ascii wide
        $proc2 = "TerminateProcess" ascii wide
        $proc3 = "OpenProcess" ascii wide
        $proc4 = "ReadProcessMemory" ascii wide
        $proc5 = "WriteProcessMemory" ascii wide
        $proc6 = "VirtualAllocEx" ascii wide
        $proc7 = "VirtualProtectEx" ascii wide

    condition:
        2 of ($proc*)
}

rule Suspicious_Strings
{
    meta:
        description = "检测可疑字符串"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "low"
        category = "strings"

    strings:
        $str1 = "cmd.exe" ascii wide
        $str2 = "powershell" ascii wide
        $str3 = "rundll32" ascii wide
        $str4 = "regsvr32" ascii wide
        $str5 = "svchost.exe" ascii wide
        $str6 = "explorer.exe" ascii wide
        $str7 = "winlogon.exe" ascii wide
        $str8 = "lsass.exe" ascii wide

    condition:
        2 of ($str*)
}

rule Keylogger_Indicators
{
    meta:
        description = "检测键盘记录器特征"
        author = "Virus Sandbox System"
        date = "2024-01-01"
        severity = "high"
        category = "keylogger"

    strings:
        $key1 = "SetWindowsHookEx" ascii wide
        $key2 = "GetAsyncKeyState" ascii wide
        $key3 = "GetKeyState" ascii wide
        $key4 = "MapVirtualKey" ascii wide
        $key5 = "GetKeyboardState" ascii wide
        $key6 = "WH_KEYBOARD" ascii wide
        $key7 = "WH_KEYBOARD_LL" ascii wide

    condition:
        any of ($key*)
}